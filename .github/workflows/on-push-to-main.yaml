name: Deploy Next.js Build to S3

on:
  push:
    branches:
      - main
      - feature/*

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install and Build
        env:
          SOCIAL_PILOT_API_BASE_URL: https://socialpilot.zynous.com
        run: |
          pnpm install --frozen-lockfile
          pnpm run build

      # Configure AWS CLI using OIDC and AssumeRole
      - name: Configure AWS credentials
        if: github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::324037318957:role/ZynousGithubControlledAccessRole
          aws-region: us-east-1 # Change to your desired AWS region

      # Sync the build output to S3
      - name: Sync build output to S3
        if: github.ref == 'refs/heads/main'
        run: |
          aws s3 sync out s3://socialpilot.zynous.com --delete --cache-control "public, max-age=31536000, immutable"

      # Invalidate CloudFront cache if distribution exists
      - name: Invalidate CloudFront cache
        if: github.ref == 'refs/heads/main'
        run: |
          # Get distribution ID for socialpilot.zynous.com
          DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Aliases.Items[?contains(@, 'zynous.com')]].Id" --output text)

          # If distribution exists, invalidate cache
          if [ ! -z "$DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
            echo "CloudFront cache invalidation created for distribution $DISTRIBUTION_ID"
          else
            echo "No CloudFront distribution found for socialpilot.zynous.com"
          fi
